# ============================================================
# QuantaAlpha run configuration
# All experiment parameters are consolidated here
# ============================================================

# ============================================================
# PLANNING CONFIGURATION
# Controls parallel exploration direction generation
# ============================================================
planning:
  # Enable "parallel planning": expand initial direction into N exploration directions
  enabled: true
  # Number of parallel directions generated by planning
  num_directions: 2
  # Max retries for planning when LLM output does not match JSON format
  max_attempts: 5
  # Use LLM to generate directions: true=call LLM; false=fallback only
  use_llm: true
  # Allow fallback when LLM fails: true=use built-in direction templates
  allow_fallback: true
  # Planning prompts file path (relative to qlib_rd_loop directory)
  prompt_file: planning_prompts.yaml


# ============================================================
# EXECUTION CONFIGURATION
# Controls main loop execution parameters
# ============================================================
execution:
  # Max loop iterations; multiplied by steps_per_loop to get step_n when step_n not set
  max_loops: 2
  # Steps per loop: fixed at 5 (propose/construct/calculate/backtest/feedback)
  steps_per_loop: 5
  # Total steps (highest priority); overrides max_loops * steps_per_loop when set
  step_n: null
  # Use local environment for backtest: true=local, false=Docker
  use_local: true
  # Run branches in parallel using multiprocessing
  parallel_execution: false
  # Branch log root; used only when parallel planning enabled with >1 branches
  branch_log_root: log
  # Branch log prefix; log directory name format is {prefix}_{index}
  branch_log_prefix: branch


# ============================================================
# EVOLUTION CONFIGURATION
# Controls evolutionary exploration (mutation and crossover)
# Flow: Original → Mutation → Crossover → Mutation → Crossover → ...
# ============================================================
evolution:
  # Enable evolution mode; overrides traditional planning + parallel execution when enabled
  enabled: true

  # Enable mutation phase; when false, skip mutation rounds (original and crossover only)
  mutation_enabled: true

  # Enable crossover phase; when false, skip crossover rounds (original and mutation only)
  crossover_enabled: true

  # Max evolution rounds (including original, mutation, crossover)
  # Flow: both enabled → round 0=original, 1=mutation, 2=crossover, ...
  #       mutation only → round 0=original, 1+=mutation, ...
  #       crossover only → round 0=original, 1+=crossover, ...
  max_rounds: 3

  # Crossover: number of parents selected per crossover operation
  crossover_size: 2
  # Crossover: number of combinations per round (parallelism after crossover)
  crossover_n: 2

  # Parallel execution within each evolution phase
  # true: original round = all n directions in parallel; mutation/crossover rounds = all tasks in parallel
  # false: tasks run sequentially
  parallel_enabled: false

  # Prefer diverse crossover combinations (different directions/phases) vs random parent selection
  prefer_diverse_crossover: true

  # Evolution prompts file path (relative to qlib_rd_loop directory)
  prompt_file: evolution_prompts.yaml

  # Parent selection strategy:
  #   best: prioritize best-performing trajectories
  #   random: random selection
  #   weighted: performance-weighted sampling (higher performance = higher weight)
  #   weighted_inverse: inverse performance-weighted (encourage exploring low performers)
  #   top_percent_plus_random: top 30% guaranteed + random from rest (balance exploitation/exploration)
  parent_selection_strategy: best

  # Top percent threshold (only when parent_selection_strategy = "top_percent_plus_random")
  top_percent_threshold: 0.3

  # Fresh start: true=each experiment starts with empty trajectory pool; false=load existing if available
  fresh_start: true

  # Cleanup on finish: true=delete trajectory pool file after experiment; false=keep for analysis
  cleanup_on_finish: false


# ============================================================
# QUALITY GATE CONFIGURATION
# Controls factor quality checks before backtesting
# ============================================================
quality_gate:
  # Consistency check (hypothesis–description–expression). Uses LLM to verify and correct expression if needed
  consistency_enabled: false

  # Complexity check: symbol length, base features count, free args ratio
  complexity_enabled: true

  # Redundancy check: AST-based subtree matching against factor zoo
  redundancy_enabled: true

  # Strict consistency: true=any inconsistency rejects factor; false=only major/critical
  consistency_strict_mode: false

  # Max correction attempts when inconsistency is found
  max_correction_attempts: 3


# ============================================================
# FACTOR GENERATION CONFIGURATION
# Controls factor proposal and expression generation
# ============================================================
factor:
  # Number of factors to generate per hypothesis
  factors_per_hypothesis: 1

  # Complexity constraints (important for preventing overfitting; keep symbol length under ~250)
  complexity:
    symbol_length_threshold: 200
    base_features_threshold: 5
    free_args_ratio_threshold: 0.5

  # Uniqueness/duplication checking against factor zoo
  duplication:
    enabled: true
    threshold: 5
    factor_zoo_path: null  # Use default when null


# ============================================================
# BACKTEST CONFIGURATION
# Controls factor backtesting parameters
# ============================================================
backtest:
  use_docker: false
  timeout: 800
  qlib:
    config_name: conf_baseline.yaml


# ============================================================
# LLM CONFIGURATION
# Controls LLM API behavior
# ============================================================
llm:
  factor_mining_timeout: 999999
  max_retries: 3
  retry_delay: 1.0
  json_mode_strict: true


# ============================================================
# LOGGING CONFIGURATION
# ============================================================
logging:
  level: INFO
  save_snapshots: true
  save_trajectory_pool: true


# ============================================================
# PROMPT FILES CONFIGURATION
# Paths relative to qlib_rd_loop directory
# Factor/hypothesis prompts: quantaalpha/scenarios/qlib/prompts_*.yaml
# ============================================================
prompts:
  planning: planning_prompts.yaml
  evolution: evolution_prompts.yaml
